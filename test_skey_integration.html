<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-KEY + WASM Integration Test - Lufalyze</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 8px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 32px;
            font-size: 1.1rem;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .status-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-card.active {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .status-card.error {
            border-color: #f56565;
            background: #fff5f5;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #4fd1c7 0%, #81e6d9 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }

        .file-input {
            margin-bottom: 16px;
        }

        .file-input input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input input[type="file"]:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .result-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .result-card h3 {
            color: #2d3748;
            margin-bottom: 16px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #4a5568;
        }

        .result-value {
            color: #2d3748;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f56565 0%, #ed8936 50%, #48bb78 100%);
            transition: width 0.5s ease;
        }

        .scales-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
        }

        .scale-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            margin: 2px 0;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .chroma-visualization {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 4px;
            margin-top: 12px;
        }

        .chroma-bar {
            height: 60px;
            background: #e2e8f0;
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: end;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a5568;
            padding-bottom: 4px;
        }

        .chroma-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: height 0.5s ease;
        }

        .benchmark-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 16px;
        }

        .benchmark-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .benchmark-item h4 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .progress {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 4px;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.warning {
            color: #f6e05e;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .note-labels {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .results {
                grid-template-columns: 1fr;
            }
            
            .benchmark-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº S-KEY + WASM Integration Test</h1>
        <p class="subtitle">State-of-the-art key detection with neural networks + traditional algorithms</p>

        <!-- System Status -->
        <div class="status-section">
            <div class="status-card" id="wasm-status">
                <div class="status-icon">‚ö°</div>
                <h3>WASM Engine</h3>
                <p id="wasm-info">Initializing...</p>
            </div>
            <div class="status-card" id="skey-status">
                <div class="status-icon">üß†</div>
                <h3>S-KEY Neural Network</h3>
                <p id="skey-info">Initializing...</p>
            </div>
            <div class="status-card" id="tensorflow-status">
                <div class="status-icon">üîß</div>
                <h3>TensorFlow.js</h3>
                <p id="tensorflow-info">Loading...</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="file-input">
                <input type="file" id="audioFile" accept="audio/*" />
                <label for="audioFile">üìÅ Select Audio File</label>
            </div>
            <button class="btn" id="analyzeBtn" disabled>üéµ Analyze Music</button>
            <button class="btn secondary" id="benchmarkBtn" disabled>‚è±Ô∏è Benchmark</button>
            <button class="btn secondary" id="testFilesBtn">üéº Test Sample Files</button>
            <button class="btn danger" id="toggleSkey">üîÑ Toggle S-KEY</button>
        </div>

        <!-- Progress -->
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- Results -->
        <div class="results" id="results" style="display: none;">
            <!-- Analysis Results -->
            <div class="result-card">
                <h3>üéπ Key Detection Results</h3>
                <div class="result-item">
                    <span class="result-label">Detected Key:</span>
                    <span class="result-value" id="detectedKey">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Method:</span>
                    <span class="result-value" id="detectionMethod">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Confidence:</span>
                    <span class="result-value" id="confidence">-</span>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                </div>
                <div class="result-item">
                    <span class="result-label">Enhanced:</span>
                    <span class="result-value" id="enhanced">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Tonal Clarity:</span>
                    <span class="result-value" id="tonalClarity">-</span>
                </div>
            </div>

            <!-- Chroma Visualization -->
            <div class="result-card">
                <h3>üåà Chroma Profile</h3>
                <div class="note-labels">
                    <div>C</div><div>C#</div><div>D</div><div>D#</div>
                    <div>E</div><div>F</div><div>F#</div><div>G</div>
                    <div>G#</div><div>A</div><div>A#</div><div>B</div>
                </div>
                <div class="chroma-visualization" id="chromaViz">
                    <!-- Chroma bars will be generated here -->
                </div>
            </div>

            <!-- Scale Analysis -->
            <div class="result-card">
                <h3>üéº Scale Analysis</h3>
                <div class="scales-list" id="scalesList">
                    <!-- Scale matches will be displayed here -->
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="result-card">
                <h3>‚ö° Performance Metrics</h3>
                <div class="benchmark-grid" id="benchmarkResults">
                    <!-- Benchmark results will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="container">
            <h3>üìã Activity Log</h3>
            <div class="log" id="activityLog">
                <div class="log-entry">System initializing...</div>
            </div>
        </div>
    </div>

    <!-- Include TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@4.15.0/dist/tf-backend-wasm.min.js"></script>

    <script>
        // Global state
        let enhancedAnalyzer = null;
        let isInitialized = false;
        let skeyEnabled = true;

        // Logging function
        function log(message, type = 'info') {
            const logElement = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Update status cards
        function updateStatus(id, status, message, isActive = false) {
            const card = document.getElementById(id);
            const info = document.getElementById(id.replace('-status', '-info'));
            
            card.className = `status-card ${isActive ? 'active' : status === 'error' ? 'error' : ''}`;
            info.textContent = message;
        }

        // Enhanced Music Analyzer Class (Simplified for testing)
        class TestEnhancedMusicAnalyzer {
            constructor() {
                this.wasmModule = null;
                this.wasmAnalyzer = null;
                this.tfModel = null;
                this.isInitialized = false;
                this.skeyEnabled = true;
            }

            async initialize() {
                try {
                    log('üöÄ Initializing Enhanced Music Analyzer...', 'info');
                    
                    // Initialize TensorFlow.js
                    await this.initializeTensorFlow();
                    
                    // Initialize WASM
                    await this.initializeWASM();
                    
                    // Initialize S-KEY model
                    await this.initializeSKEY();
                    
                    this.isInitialized = true;
                    log('‚úÖ Enhanced Music Analyzer initialized successfully!', 'success');
                    
                    // Enable buttons
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('benchmarkBtn').disabled = false;
                    
                } catch (error) {
                    log(`‚ùå Initialization failed: ${error.message}`, 'error');
                    throw error;
                }
            }

            async initializeTensorFlow() {
                try {
                    updateStatus('tensorflow-status', 'loading', 'Setting up TensorFlow.js...');
                    
                    // Set WASM backend
                    await tf.setBackend('wasm');
                    await tf.ready();
                    
                    const backendName = tf.getBackend();
                    updateStatus('tensorflow-status', 'success', `Backend: ${backendName}`, true);
                    log(`‚úÖ TensorFlow.js initialized with ${backendName} backend`, 'success');
                    
                } catch (error) {
                    updateStatus('tensorflow-status', 'error', 'Failed to initialize');
                    throw new Error(`TensorFlow.js initialization failed: ${error.message}`);
                }
            }

            async initializeWASM() {
                try {
                    updateStatus('wasm-status', 'loading', 'Loading WASM module...');
                    
                    // Try to load WASM module
                    try {
                        this.wasmModule = await import('/loudness_wasm.js');
                        await this.wasmModule.default();
                        this.wasmAnalyzer = new this.wasmModule.MusicAnalyzer(44100);
                        
                        updateStatus('wasm-status', 'success', 'WASM engine loaded', true);
                        log('‚úÖ WASM module loaded successfully', 'success');
                    } catch (wasmError) {
                        // Fallback: Create mock WASM analyzer
                        log('‚ö†Ô∏è WASM module not found, using mock implementation', 'warning');
                        this.wasmAnalyzer = this.createMockWASMAnalyzer();
                        updateStatus('wasm-status', 'warning', 'Using mock implementation');
                    }
                    
                } catch (error) {
                    updateStatus('wasm-status', 'error', 'Failed to load');
                    throw new Error(`WASM initialization failed: ${error.message}`);
                }
            }

            async initializeSKEY() {
                try {
                    updateStatus('skey-status', 'loading', 'Loading S-KEY model...');
                    
                    // Create a simple S-KEY model for demonstration
                    this.tfModel = tf.sequential({
                        layers: [
                            tf.layers.dense({
                                inputShape: [15], // 12 chroma + 3 auxiliary
                                units: 64,
                                activation: 'relu',
                                name: 'encoder'
                            }),
                            tf.layers.dense({
                                units: 24, // 12 major + 12 minor
                                activation: 'softmax',
                                name: 'key_classifier'
                            })
                        ]
                    });
                    
                    updateStatus('skey-status', 'success', 'S-KEY model ready', true);
                    log('‚úÖ S-KEY neural network model created', 'success');
                    
                } catch (error) {
                    updateStatus('skey-status', 'error', 'Failed to load');
                    this.skeyEnabled = false;
                    throw new Error(`S-KEY initialization failed: ${error.message}`);
                }
            }

            createMockWASMAnalyzer() {
                return {
                    analyze_music: (pcmData) => {
                        // Mock analysis result
                        const keys = ['C Major', 'G Major', 'D Minor', 'A Minor', 'F Major', 'E Minor'];
                        const randomKey = keys[Math.floor(Math.random() * keys.length)];
                        const confidence = 0.4 + Math.random() * 0.5; // 40-90%
                        
                        return {
                            key: randomKey,
                            root_note: randomKey.split(' ')[0],
                            is_major: randomKey.includes('Major'),
                            confidence: confidence,
                            tonal_clarity: Math.random() * 0.8,
                            harmonic_complexity: Math.random() * 0.6,
                            chroma: Array.from({length: 12}, () => Math.random()),
                            scales: [
                                {name: randomKey, strength: confidence, category: randomKey.includes('Major') ? 'Major Family' : 'Minor Family'},
                                {name: 'Pentatonic Major', strength: confidence * 0.8, category: 'Pentatonic'},
                                {name: 'Blues', strength: confidence * 0.6, category: 'Blues'}
                            ]
                        };
                    },
                    analyze_music_with_skey: null, // Not available in mock
                    benchmark_algorithms: null
                };
            }

            async analyzeMusic(pcmData) {
                if (!this.isInitialized) {
                    throw new Error('Analyzer not initialized');
                }

                log('üéµ Starting music analysis...', 'info');
                
                // Traditional analysis
                const traditionalResult = this.wasmAnalyzer.analyze_music(pcmData);
                let finalResult = traditionalResult;
                
                // S-KEY enhancement if enabled and confidence is low
                if (this.skeyEnabled && this.tfModel && traditionalResult.confidence < 0.8) {
                    try {
                        log('üß† Running S-KEY enhancement...', 'info');
                        const skeyResult = await this.runSKEYAnalysis(pcmData, traditionalResult);
                        
                        if (skeyResult.confidence > traditionalResult.confidence) {
                            finalResult = {
                                ...skeyResult,
                                method: 'S-KEY Enhanced',
                                enhanced: true,
                                traditional_confidence: traditionalResult.confidence
                            };
                            log('‚ú® S-KEY enhancement applied!', 'success');
                        } else {
                            finalResult.method = 'Traditional';
                            finalResult.enhanced = false;
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è S-KEY enhancement failed: ${error.message}`, 'warning');
                        finalResult.method = 'Traditional (S-KEY failed)';
                        finalResult.enhanced = false;
                    }
                } else {
                    finalResult.method = traditionalResult.confidence > 0.7 ? 'Traditional (High Confidence)' : 'Traditional';
                    finalResult.enhanced = false;
                }

                log(`üéØ Analysis complete: ${finalResult.key} (${(finalResult.confidence * 100).toFixed(1)}% confidence)`, 'success');
                return finalResult;
            }

            async runSKEYAnalysis(pcmData, traditionalResult) {
                // Extract features for S-KEY
                const features = this.extractSKEYFeatures(pcmData, traditionalResult);
                
                // Run neural network inference
                const inputTensor = tf.tensor2d([features]);
                const prediction = this.tfModel.predict(inputTensor);
                const probabilities = await prediction.data();
                
                // Cleanup
                inputTensor.dispose();
                prediction.dispose();
                
                // Decode prediction
                return this.decodeSKEYPrediction(Array.from(probabilities), traditionalResult);
            }

            extractSKEYFeatures(pcmData, traditionalResult) {
                // Use chroma from traditional analysis + mock auxiliary features
                const chroma = traditionalResult.chroma || Array.from({length: 12}, () => Math.random());
                const spectralCentroid = Math.random(); // Mock feature
                const zeroCrossingRate = Math.random(); // Mock feature
                const rmsEnergy = Math.random(); // Mock feature
                
                return [...chroma, spectralCentroid, zeroCrossingRate, rmsEnergy];
            }

            decodeSKEYPrediction(probabilities, traditionalResult) {
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                // Find highest probability
                const maxIdx = probabilities.indexOf(Math.max(...probabilities));
                const confidence = Math.max(...probabilities);
                
                const root = maxIdx % 12;
                const isMajor = maxIdx < 12;
                
                return {
                    key: `${noteNames[root]} ${isMajor ? 'Major' : 'Minor'}`,
                    root_note: noteNames[root],
                    is_major: isMajor,
                    confidence: confidence,
                    tonal_clarity: traditionalResult.tonal_clarity,
                    harmonic_complexity: traditionalResult.harmonic_complexity,
                    chroma: traditionalResult.chroma,
                    scales: traditionalResult.scales
                };
            }

            async benchmark(pcmData) {
                log('‚è±Ô∏è Starting performance benchmark...', 'info');
                
                // Traditional benchmark
                const traditionalStart = performance.now();
                const traditionalResult = this.wasmAnalyzer.analyze_music(pcmData);
                const traditionalTime = performance.now() - traditionalStart;
                
                // S-KEY benchmark
                let skeyResult = null;
                let skeyTime = 0;
                
                if (this.skeyEnabled && this.tfModel) {
                    const skeyStart = performance.now();
                    try {
                        skeyResult = await this.runSKEYAnalysis(pcmData, traditionalResult);
                        skeyTime = performance.now() - skeyStart;
                    } catch (error) {
                        log(`‚ö†Ô∏è S-KEY benchmark failed: ${error.message}`, 'warning');
                    }
                }
                
                const results = {
                    traditional: {
                        key: traditionalResult.key,
                        confidence: traditionalResult.confidence,
                        time_ms: traditionalTime
                    },
                    skey: {
                        key: skeyResult?.key,
                        confidence: skeyResult?.confidence,
                        available: this.skeyEnabled && this.tfModel !== null,
                        time_ms: skeyTime
                    }
                };
                
                log(`üìä Benchmark complete: Traditional ${traditionalTime.toFixed(1)}ms, S-KEY ${skeyTime.toFixed(1)}ms`, 'success');
                return results;
            }

            setSKEYEnabled(enabled) {
                this.skeyEnabled = enabled;
                log(`üîÑ S-KEY ${enabled ? 'enabled' : 'disabled'}`, 'info');
            }
        }

        // File handling
        async function loadAudioFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const arrayBuffer = e.target.result;
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        
                        // Convert to mono Float32Array
                        const pcmData = audioBuffer.getChannelData(0);
                        resolve(pcmData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Progress bar
        function updateProgress(percentage) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            if (percentage > 0) {
                progressContainer.style.display = 'block';
                progressBar.style.width = `${percentage}%`;
            } else {
                progressContainer.style.display = 'none';
            }
        }

        // Display results
        function displayResults(result) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.style.display = 'grid';
            
            // Key detection results
            document.getElementById('detectedKey').textContent = result.key;
            document.getElementById('detectionMethod').textContent = result.method;
            document.getElementById('confidence').textContent = `${(result.confidence * 100).toFixed(1)}%`;
            document.getElementById('enhanced').textContent = result.enhanced ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('tonalClarity').textContent = `${(result.tonal_clarity * 100).toFixed(1)}%`;
            
            // Confidence bar
            const confidenceFill = document.getElementById('confidenceFill');
            confidenceFill.style.width = `${result.confidence * 100}%`;
            
            // Chroma visualization
            displayChromaVisualization(result.chroma);
            
            // Scales
            displayScales(result.scales);
        }

        function displayChromaVisualization(chroma) {
            const chromaViz = document.getElementById('chromaViz');
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            chromaViz.innerHTML = '';
            
            chroma.forEach((value, index) => {
                const bar = document.createElement('div');
                bar.className = 'chroma-bar';
                
                const fill = document.createElement('div');
                fill.className = 'chroma-fill';
                fill.style.height = `${value * 100}%`;
                
                bar.appendChild(fill);
                bar.appendChild(document.createTextNode(noteNames[index]));
                chromaViz.appendChild(bar);
            });
        }

        function displayScales(scales) {
            const scalesList = document.getElementById('scalesList');
            scalesList.innerHTML = '';
            
            scales.forEach(scale => {
                const item = document.createElement('div');
                item.className = 'scale-item';
                item.innerHTML = `
                    <span>${scale.name}</span>
                    <span>${(scale.strength * 100).toFixed(1)}%</span>
                `;
                scalesList.appendChild(item);
            });
        }

        function displayBenchmark(benchmark) {
            const benchmarkResults = document.getElementById('benchmarkResults');
            benchmarkResults.innerHTML = `
                <div class="benchmark-item">
                    <h4>üîß Traditional Algorithm</h4>
                    <div class="result-item">
                        <span>Key:</span>
                        <span>${benchmark.traditional.key}</span>
                    </div>
                    <div class="result-item">
                        <span>Confidence:</span>
                        <span>${(benchmark.traditional.confidence * 100).toFixed(1)}%</span>
                    </div>
                    <div class="result-item">
                        <span>Time:</span>
                        <span>${benchmark.traditional.time_ms.toFixed(1)}ms</span>
                    </div>
                </div>
                <div class="benchmark-item">
                    <h4>üß† S-KEY Neural Network</h4>
                    <div class="result-item">
                        <span>Available:</span>
                        <span>${benchmark.skey.available ? '‚úÖ Yes' : '‚ùå No'}</span>
                    </div>
                    <div class="result-item">
                        <span>Key:</span>
                        <span>${benchmark.skey.key || 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span>Confidence:</span>
                        <span>${benchmark.skey.confidence ? (benchmark.skey.confidence * 100).toFixed(1) + '%' : 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span>Time:</span>
                        <span>${benchmark.skey.time_ms.toFixed(1)}ms</span>
                    </div>
                </div>
            `;
        }

        // Test with sample audio
        function generateTestAudio() {
            // Generate a simple sine wave for testing (A4 = 440 Hz)
            const sampleRate = 44100;
            const duration = 2; // 2 seconds
            const frequency = 440; // A4
            const samples = sampleRate * duration;
            
            const pcmData = new Float32Array(samples);
            for (let i = 0; i < samples; i++) {
                pcmData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.3;
            }
            
            return pcmData;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                enhancedAnalyzer = new TestEnhancedMusicAnalyzer();
                await enhancedAnalyzer.initialize();
            } catch (error) {
                log(`‚ùå Failed to initialize: ${error.message}`, 'error');
            }
        });

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('audioFile');
            
            if (!fileInput.files[0]) {
                log('‚ö†Ô∏è Please select an audio file first', 'warning');
                return;
            }
            
            try {
                updateProgress(10);
                log('üìÅ Loading audio file...', 'info');
                
                const pcmData = await loadAudioFile(fileInput.files[0]);
                updateProgress(50);
                
                log('üéµ Analyzing music...', 'info');
                const result = await enhancedAnalyzer.analyzeMusic(pcmData);
                updateProgress(100);
                
                displayResults(result);
                updateProgress(0);
                
            } catch (error) {
                log(`‚ùå Analysis failed: ${error.message}`, 'error');
                updateProgress(0);
            }
        });

        document.getElementById('benchmarkBtn').addEventListener('click', async () => {
            try {
                updateProgress(10);
                log('üîÑ Generating test audio...', 'info');
                
                const testAudio = generateTestAudio();
                updateProgress(30);
                
                log('‚è±Ô∏è Running benchmark...', 'info');
                const benchmark = await enhancedAnalyzer.benchmark(testAudio);
                updateProgress(100);
                
                displayBenchmark(benchmark);
                updateProgress(0);
                
            } catch (error) {
                log(`‚ùå Benchmark failed: ${error.message}`, 'error');
                updateProgress(0);
            }
        });

        document.getElementById('testFilesBtn').addEventListener('click', async () => {
            try {
                log('üéº Testing with synthetic audio samples...', 'info');
                updateProgress(10);
                
                const testAudio = generateTestAudio();
                updateProgress(50);
                
                const result = await enhancedAnalyzer.analyzeMusic(testAudio);
                updateProgress(100);
                
                displayResults(result);
                updateProgress(0);
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                updateProgress(0);
            }
        });

        document.getElementById('toggleSkey').addEventListener('click', () => {
            skeyEnabled = !skeyEnabled;
            enhancedAnalyzer?.setSKEYEnabled(skeyEnabled);
            
            const button = document.getElementById('toggleSkey');
            button.textContent = skeyEnabled ? 'üîÑ Disable S-KEY' : 'üîÑ Enable S-KEY';
            button.className = skeyEnabled ? 'btn danger' : 'btn secondary';
        });
    </script>
</body>
</html> 