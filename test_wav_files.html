<!DOCTYPE html>
<html>
<head>
    <title>WAV File Key Detection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .result { margin: 10px 0; }
        .loading { color: blue; }
        .success { color: green; }
        .error { color: red; }
        .chroma-bar { display: inline-block; height: 20px; margin: 2px; background: #007bff; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .progress { background: #f0f0f0; border-radius: 10px; padding: 3px; margin: 10px 0; }
        .progress-bar { background: #007bff; height: 20px; border-radius: 10px; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <h1>WAV File Key Detection Test</h1>
    
    <div class="test-section">
        <h2>Test Available WAV Files</h2>
        <button onclick="testFile('1.wav')" id="btn1">Test 1.wav (20MB)</button>
        <button onclick="testFile('testfile.wav')" id="btn2">Test testfile.wav (51MB)</button>
        <button onclick="testBothFiles()" id="btnBoth">Test Both Files</button>
        <button onclick="clearResults()" id="btnClear">Clear Results</button>
    </div>

    <div class="test-section">
        <h2>Manual File Upload</h2>
        <input type="file" id="manualFile" accept="audio/*">
        <button onclick="testManualFile()">Test Uploaded File</button>
    </div>

    <div id="progress" class="progress" style="display: none;">
        <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
        <div id="progressText" style="text-align: center; margin-top: 5px;">Processing...</div>
    </div>

    <div id="results"></div>

    <script type="module">
        import init, { MusicAnalyzer } from './public/loudness_wasm.js';

        let musicAnalyzer;
        let isInitialized = false;

        async function initializeWasm() {
            if (isInitialized) return;
            
            try {
                await init();
                musicAnalyzer = new MusicAnalyzer(44100);
                console.log('WASM initialized successfully');
                isInitialized = true;
            } catch (error) {
                console.error('Failed to initialize WASM:', error);
                addResult('Error', `Failed to initialize WASM: ${error.message}`, 'error');
            }
        }

        function updateProgress(percentage, text = 'Processing...') {
            const progressDiv = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';
            progressBar.style.width = percentage + '%';
            progressText.textContent = text;
            
            if (percentage >= 100) {
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 1000);
            }
        }

        function addResult(filename, content, className = '') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${className}`;
            resultDiv.innerHTML = `
                <div class="test-section">
                    <h3>${filename}</h3>
                    ${content}
                </div>
            `;
            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function formatChromaVector(chroma) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const maxValue = Math.max(...chroma);
            
            return chroma.map((value, index) => {
                const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                return `<div style="display: inline-block; margin: 2px; text-align: center;">
                    <div style="background: hsl(${(index * 30) % 360}, 70%, 50%); height: ${Math.max(3, percentage)}px; width: 20px; margin-bottom: 2px;"></div>
                    <div style="font-size: 10px;">${noteNames[index]}</div>
                </div>`;
            }).join('');
        }

        async function testAudioFile(filename, audioData) {
            if (!isInitialized) {
                await initializeWasm();
            }

            updateProgress(10, 'Initializing analysis...');
            
            try {
                // Create audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                updateProgress(30, 'Decoding audio...');
                const audioBuffer = await audioContext.decodeAudioData(audioData);
                
                updateProgress(50, 'Extracting audio data...');
                // Get mono channel data
                const pcmData = audioBuffer.getChannelData(0);
                const float32Array = new Float32Array(pcmData);
                
                updateProgress(70, 'Running key detection...');
                // Run key detection
                const startTime = performance.now();
                const result = musicAnalyzer.analyze_music(float32Array);
                const endTime = performance.now();
                
                updateProgress(100, 'Analysis complete!');
                
                // Log detailed results
                console.log(`Key detection result for ${filename}:`, result);
                
                // Format results
                const content = `
                    <p><strong>File:</strong> ${filename}</p>
                    <p><strong>Duration:</strong> ${audioBuffer.duration.toFixed(2)} seconds</p>
                    <p><strong>Sample Rate:</strong> ${audioBuffer.sampleRate} Hz</p>
                    <p><strong>Channels:</strong> ${audioBuffer.numberOfChannels}</p>
                    <hr>
                    <p><strong>ðŸŽµ Detected Key:</strong> <span style="font-size: 1.2em; font-weight: bold; color: #007bff;">${result.key}</span></p>
                    <p><strong>Root Note:</strong> ${result.root_note}</p>
                    <p><strong>Mode:</strong> ${result.is_major ? 'Major' : 'Minor'}</p>
                    <p><strong>Confidence:</strong> <span style="font-weight: bold; ${result.confidence > 0.7 ? 'color: green;' : result.confidence > 0.4 ? 'color: orange;' : 'color: red;'}">${(result.confidence * 100).toFixed(1)}%</span></p>
                    <p><strong>Tonal Clarity:</strong> ${(result.tonal_clarity * 100).toFixed(1)}%</p>
                    <p><strong>Harmonic Complexity:</strong> ${(result.harmonic_complexity * 100).toFixed(1)}%</p>
                    <p><strong>Processing Time:</strong> ${(endTime - startTime).toFixed(1)}ms</p>
                    <hr>
                    <h4>Chroma Vector Visualization:</h4>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                        ${formatChromaVector(result.chroma)}
                    </div>
                    <details>
                        <summary><strong>Scale Analysis</strong></summary>
                        ${result.scales.map(scale => 
                            `<p>${scale.name}: <strong>${(scale.strength * 100).toFixed(1)}%</strong> (${scale.category})</p>`
                        ).join('')}
                    </details>
                    <details>
                        <summary><strong>Raw Chroma Values</strong></summary>
                        <p style="font-family: monospace; font-size: 0.9em;">
                            ${result.chroma.map((v, i) => `${['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][i]}: ${v.toFixed(4)}`).join('<br>')}
                        </p>
                    </details>
                `;
                
                addResult(filename, content, 'success');
                
            } catch (error) {
                updateProgress(100, 'Error occurred');
                console.error(`Error testing ${filename}:`, error);
                addResult(filename, `<p style="color: red;">Error: ${error.message}</p>`, 'error');
            }
        }

        async function testFile(filename) {
            const button = document.getElementById(filename === '1.wav' ? 'btn1' : 'btn2');
            button.disabled = true;
            
            try {
                addResult(filename, '<p class="loading">Loading file...</p>', 'loading');
                
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                await testAudioFile(filename, arrayBuffer);
                
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                addResult(filename, `<p style="color: red;">Error loading file: ${error.message}</p>`, 'error');
            } finally {
                button.disabled = false;
            }
        }

        async function testManualFile() {
            const fileInput = document.getElementById('manualFile');
            if (!fileInput.files[0]) {
                alert('Please select an audio file');
                return;
            }

            const file = fileInput.files[0];
            try {
                const arrayBuffer = await file.arrayBuffer();
                await testAudioFile(file.name, arrayBuffer);
            } catch (error) {
                console.error('Error testing manual file:', error);
                addResult(file.name, `<p style="color: red;">Error: ${error.message}</p>`, 'error');
            }
        }

        async function testBothFiles() {
            const btnBoth = document.getElementById('btnBoth');
            btnBoth.disabled = true;
            
            try {
                await testFile('1.wav');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause between tests
                await testFile('testfile.wav');
            } finally {
                btnBoth.disabled = false;
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Make functions globally available
        window.testFile = testFile;
        window.testManualFile = testManualFile;
        window.testBothFiles = testBothFiles;
        window.clearResults = clearResults;
        
        // Initialize on page load
        initializeWasm();
    </script>
</body>
</html> 