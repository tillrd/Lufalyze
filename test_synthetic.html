<!DOCTYPE html>
<html>
<head>
    <title>Synthetic Key Detection Test</title>
</head>
<body>
    <h1>Synthetic Key Detection Test</h1>
    <button onclick="testCMajor()">Test C Major</button>
    <button onclick="testAMinor()">Test A Minor</button>
    <button onclick="testGMajor()">Test G Major</button>
    <button onclick="testBbMinor()">Test B♭ Minor</button>
    <div id="results"></div>

    <script type="module">
        import init, { MusicAnalyzer } from './public/loudness_wasm.js';

        let musicAnalyzer;

        async function initializeWasm() {
            await init();
            musicAnalyzer = new MusicAnalyzer(44100);
            console.log('WASM initialized successfully');
        }

        // Generate synthetic audio for a specific chord
        function generateChord(frequencies, sampleRate = 44100, duration = 2.0) {
            const numSamples = Math.floor(sampleRate * duration);
            const samples = new Float32Array(numSamples);
            
            for (let i = 0; i < numSamples; i++) {
                let sample = 0;
                for (const freq of frequencies) {
                    sample += Math.sin(2 * Math.PI * freq * i / sampleRate) * 0.3;
                }
                samples[i] = sample / frequencies.length;
            }
            
            return samples;
        }

        async function testKey(keyName, frequencies) {
            if (!musicAnalyzer) {
                await initializeWasm();
            }

            console.log(`Testing ${keyName} with frequencies:`, frequencies);
            
            // Generate synthetic audio
            const audioData = generateChord(frequencies);
            
            // Test the key detection
            const startTime = performance.now();
            const result = musicAnalyzer.analyze_music(audioData);
            const endTime = performance.now();
            
            console.log(`${keyName} detection result:`, result);
            
            // Display results
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `
                <div style="border: 1px solid #ccc; margin: 10px; padding: 10px;">
                    <h3>${keyName} Test Results:</h3>
                    <p><strong>Input Frequencies:</strong> ${frequencies.map(f => f.toFixed(1) + 'Hz').join(', ')}</p>
                    <p><strong>Detected Key:</strong> ${result.key}</p>
                    <p><strong>Root Note:</strong> ${result.root_note}</p>
                    <p><strong>Is Major:</strong> ${result.is_major}</p>
                    <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                    <p><strong>Tonal Clarity:</strong> ${(result.tonal_clarity * 100).toFixed(1)}%</p>
                    <p><strong>Processing Time:</strong> ${(endTime - startTime).toFixed(1)}ms</p>
                    <p style="color: ${isCorrect(keyName, result) ? 'green' : 'red'};">
                        <strong>Result: ${isCorrect(keyName, result) ? 'CORRECT ✓' : 'INCORRECT ✗'}</strong>
                    </p>
                    <details>
                        <summary>Chroma Vector</summary>
                        <p>${result.chroma.map((v, i) => `${['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][i]}: ${v.toFixed(3)}`).join(', ')}</p>
                    </details>
                    <details>
                        <summary>Scale Analysis</summary>
                        ${result.scales.map(scale => `<p>${scale.name}: ${(scale.strength * 100).toFixed(1)}%</p>`).join('')}
                    </details>
                </div>
            `;
        }

        function isCorrect(expectedKey, result) {
            const expected = expectedKey.toLowerCase();
            const actual = result.key.toLowerCase();
            return actual.includes(expected.split(' ')[0]) && 
                   actual.includes(expected.split(' ')[1]);
        }

        async function testCMajor() {
            // C Major chord: C-E-G (261.63, 329.63, 392.00 Hz)
            await testKey('C Major', [261.63, 329.63, 392.00]);
        }

        async function testAMinor() {
            // A Minor chord: A-C-E (220.00, 261.63, 329.63 Hz)
            await testKey('A Minor', [220.00, 261.63, 329.63]);
        }

        async function testGMajor() {
            // G Major chord: G-B-D (196.00, 246.94, 293.66 Hz)
            await testKey('G Major', [196.00, 246.94, 293.66]);
        }

        async function testBbMinor() {
            // Bb Minor chord: Bb-Db-F (233.08, 277.18, 349.23 Hz)
            await testKey('Bb Minor', [233.08, 277.18, 349.23]);
        }

        // Make functions globally available
        window.testCMajor = testCMajor;
        window.testAMinor = testAMinor;
        window.testGMajor = testGMajor;
        window.testBbMinor = testBbMinor;
        
        // Initialize on page load
        initializeWasm();
    </script>
</body>
</html> 