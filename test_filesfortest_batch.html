<!DOCTYPE html>
<html>
<head>
    <title>Filesfortest Batch Key Detection - Lufalyze</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section { 
            border: 1px solid #ddd; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            background: #fafafa;
        }
        .result { 
            margin: 15px 0; 
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .loading { background-color: #e3f2fd; border-color: #2196f3; }
        .success { background-color: #e8f5e8; border-color: #4caf50; }
        .warning { background-color: #fff3e0; border-color: #ff9800; }
        .error { background-color: #ffebee; border-color: #f44336; }
        .excellent { background-color: #e1f5fe; border-color: #00bcd4; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .progress { 
            background: #f0f0f0; 
            border-radius: 10px; 
            padding: 3px; 
            margin: 15px 0; 
            position: relative;
        }
        .progress-bar { 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            height: 25px; 
            border-radius: 8px; 
            transition: width 0.3s ease; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .chroma-visualization {
            display: flex;
            justify-content: center;
            align-items: end;
            gap: 3px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 10px 0;
        }
        .chroma-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 60px;
        }
        .chroma-value {
            border-radius: 4px 4px 0 0;
            min-height: 5px;
            width: 25px;
            margin-bottom: 5px;
        }
        .chroma-label {
            font-size: 10px;
            font-weight: bold;
        }
        
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº Filesfortest Batch Key Detection</h1>
        <p style="text-align: center; color: #666;">Testing scale/key recognition algorithm on all 10 WAV files from filesfortest directory</p>
        
        <div class="test-section">
            <h2>Test Controls</h2>
            <button onclick="runFullBatchTest()" id="btnBatch">üöÄ Test All 10 Files</button>
            <button onclick="runQuickTest()" id="btnQuick">‚ö° Quick Test (3 Files)</button>
            <button onclick="clearResults()" id="btnClear">üßπ Clear Results</button>
        </div>

        <div id="progress" class="progress" style="display: none;">
            <div id="progressBar" class="progress-bar" style="width: 0%;">
                <span id="progressText">Initializing...</span>
            </div>
        </div>

        <div id="summary" style="display: none;">
            <h2>üìä Algorithm Performance Summary</h2>
            <div class="summary-stats" id="summaryStats"></div>
            <div id="overallAssessment" style="margin-top: 20px; padding: 20px; border-radius: 8px;"></div>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        import init, { MusicAnalyzer } from './public/loudness_wasm.js';

        let musicAnalyzer;
        let isInitialized = false;
        let testResults = [];
        let currentTestIndex = 0;
        let totalTests = 0;

        const TEST_FILES = [
            'Test_1.wav', 'Test_2.wav', 'Test_3.wav', 'Test_4.wav', 'Test_5.wav',
            'Test_6.wav', 'Test_7.wav', 'Test_8.wav', 'Test_9.wav', 'Test_10.wav'
        ];

        async function initializeWasm() {
            if (isInitialized) return;
            
            try {
                updateProgress(10, 'Initializing WASM module...');
                await init();
                musicAnalyzer = new MusicAnalyzer(44100);
                console.log('üéº WASM initialized successfully');
                isInitialized = true;
                updateProgress(20, 'WASM ready');
            } catch (error) {
                console.error('‚ùå Failed to initialize WASM:', error);
                addResult('WASM Initialization', `Failed to initialize: ${error.message}`, 'error');
                throw error;
            }
        }

        function updateProgress(percentage, text = 'Processing...') {
            const progressDiv = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';
            progressBar.style.width = percentage + '%';
            progressText.textContent = text;
            
            if (percentage >= 100) {
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            }
        }

        function addResult(filename, content, className = '', resultData = null) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${className}`;
            resultDiv.innerHTML = `
                <div>
                    <h3>${filename}</h3>
                    ${content}
                </div>
            `;
            resultsDiv.appendChild(resultDiv);
            
            if (resultData) {
                testResults.push(resultData);
            }
            
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function formatChromaVisualization(chroma) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const maxValue = Math.max(...chroma);
            
            return `<div class="chroma-visualization">
                ${chroma.map((value, index) => {
                    const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    const height = Math.max(5, percentage * 0.5);
                    const hue = (index * 30) % 360;
                    return `<div class="chroma-bar">
                        <div class="chroma-value" style="background: hsl(${hue}, 70%, 50%); height: ${height}px;"></div>
                        <div class="chroma-label">${noteNames[index]}</div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        async function testAudioFile(filename) {
            const filePath = `filesfortest/${filename}`;
            
            try {
                updateProgress(
                    30 + (currentTestIndex / totalTests) * 60, 
                    `Testing ${filename} (${currentTestIndex + 1}/${totalTests})`
                );
                
                addResult(filename, '<p class="loading">üìÇ Loading and analyzing file...</p>', 'loading');
                
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                
                // Create audio context and decode
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Get PCM data
                const pcmData = audioBuffer.getChannelData(0);
                const float32Array = new Float32Array(pcmData);
                
                // Run key detection
                const startTime = performance.now();
                const result = musicAnalyzer.analyze_music(float32Array);
                const endTime = performance.now();
                
                // Store result data
                const resultData = {
                    filename,
                    fileSize: (arrayBuffer.byteLength / 1024 / 1024).toFixed(1),
                    duration: audioBuffer.duration.toFixed(2),
                    sampleRate: audioBuffer.sampleRate,
                    channels: audioBuffer.numberOfChannels,
                    key: result.key,
                    rootNote: result.root_note,
                    isMajor: result.is_major,
                    confidence: result.confidence,
                    tonalClarity: result.tonal_clarity,
                    harmonicComplexity: result.harmonic_complexity,
                    processingTime: endTime - startTime,
                    chroma: result.chroma,
                    scales: result.scales
                };
                
                // Format detailed results
                const content = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div>
                            <p><strong>üìÅ File:</strong> ${filename} (${resultData.fileSize} MB)</p>
                            <p><strong>‚è±Ô∏è Duration:</strong> ${resultData.duration}s</p>
                            <p><strong>üîä Sample Rate:</strong> ${resultData.sampleRate} Hz</p>
                        </div>
                        <div>
                            <p><strong>‚ö° Processing Time:</strong> ${resultData.processingTime.toFixed(1)}ms</p>
                            <p><strong>üéØ Tonal Clarity:</strong> ${(resultData.tonalClarity * 100).toFixed(1)}%</p>
                            <p><strong>üîÄ Harmonic Complexity:</strong> ${(resultData.harmonicComplexity * 100).toFixed(1)}%</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                        <h3 style="margin: 0 0 10px 0; color: white;">üéµ Detected Key</h3>
                        <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${result.key}</div>
                        <div style="font-size: 1.2em; margin: 5px 0;">Root: ${result.root_note} | Mode: ${result.is_major ? 'Major' : 'Minor'}</div>
                        <div style="font-size: 1.4em; margin-top: 10px; color: ${result.confidence >= 0.7 ? '#4caf50' : result.confidence >= 0.4 ? '#ff9800' : '#f44336'};">
                            Confidence: ${(result.confidence * 100).toFixed(1)}%
                        </div>
                    </div>

                    <h4>üéº Pitch Class Profile (Chroma Vector)</h4>
                    ${formatChromaVisualization(result.chroma)}
                    
                    <h4>üéµ Top Scale Matches</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        ${result.scales.slice(0, 5).map(scale => `
                            <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                                <div style="font-weight: bold; color: #333;">${scale.name}</div>
                                <div style="color: #666; font-size: 0.9em;">${scale.category || 'Unknown'}</div>
                                <div style="font-size: 1.2em; color: #007bff; font-weight: bold;">${(scale.strength * 100).toFixed(1)}%</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                const resultClass = result.confidence >= 0.8 && resultData.tonalClarity >= 0.6 ? 'excellent' :
                                  result.confidence >= 0.6 && resultData.tonalClarity >= 0.4 ? 'success' :
                                  result.confidence >= 0.4 ? 'warning' : 'error';
                
                // Update the loading result with actual data
                const existingResult = document.querySelector('.result:last-child');
                if (existingResult) {
                    existingResult.className = `result ${resultClass}`;
                    existingResult.innerHTML = `<div><h3>${filename}</h3>${content}</div>`;
                }
                
                currentTestIndex++;
                return resultData;
                
            } catch (error) {
                console.error(`‚ùå Error testing ${filename}:`, error);
                const errorMsg = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
                
                // Update the loading result with error
                const existingResult = document.querySelector('.result:last-child');
                if (existingResult) {
                    existingResult.className = 'result error';
                    existingResult.innerHTML = `<div><h3>${filename}</h3>${errorMsg}</div>`;
                }
                
                currentTestIndex++;
                return null;
            }
        }

        function generateSummary() {
            const validResults = testResults.filter(r => r !== null);
            const totalFiles = testResults.length;
            const successfulAnalyses = validResults.length;
            
            const avgConfidence = validResults.length > 0 ? 
                validResults.reduce((sum, r) => sum + r.confidence, 0) / validResults.length : 0;
            
            const avgTonalClarity = validResults.length > 0 ? 
                validResults.reduce((sum, r) => sum + r.tonalClarity, 0) / validResults.length : 0;
            
            const avgProcessingTime = validResults.length > 0 ? 
                validResults.reduce((sum, r) => sum + r.processingTime, 0) / validResults.length : 0;
            
            const highConfidenceCount = validResults.filter(r => r.confidence >= 0.7).length;
            const mediumConfidenceCount = validResults.filter(r => r.confidence >= 0.4 && r.confidence < 0.7).length;
            const lowConfidenceCount = validResults.filter(r => r.confidence < 0.4).length;
            
            const summaryStats = document.getElementById('summaryStats');
            summaryStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number" style="color: #4caf50;">${successfulAnalyses}</div>
                    <div class="stat-label">Successful Analyses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: ${avgConfidence >= 0.7 ? '#4caf50' : avgConfidence >= 0.4 ? '#ff9800' : '#f44336'};">
                        ${(avgConfidence * 100).toFixed(1)}%
                    </div>
                    <div class="stat-label">Average Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #2196f3;">${(avgTonalClarity * 100).toFixed(1)}%</div>
                    <div class="stat-label">Average Tonal Clarity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #9c27b0;">${avgProcessingTime.toFixed(0)}ms</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>
                <div class="stat-card">
                    <div style="text-align: left;">
                        <div style="color: #4caf50; font-weight: bold;">‚úÖ ${highConfidenceCount} High (‚â•70%)</div>
                        <div style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è ${mediumConfidenceCount} Medium (40-69%)</div>
                        <div style="color: #f44336; font-weight: bold;">‚ùå ${lowConfidenceCount} Low (<40%)</div>
                    </div>
                    <div class="stat-label">Confidence Distribution</div>
                </div>
            `;
            
            // Generate overall assessment
            let assessment = '';
            let assessmentClass = '';
            
            if (successfulAnalyses === totalFiles && avgConfidence >= 0.7 && avgTonalClarity >= 0.5) {
                assessment = `
                    <h3 style="color: #4caf50;">‚úÖ ALGORITHM WORKING EXCELLENTLY</h3>
                    <p>The scale/key recognition algorithm is performing at a high level:</p>
                    <ul>
                        <li>All ${totalFiles} files analyzed successfully</li>
                        <li>Average confidence of ${(avgConfidence * 100).toFixed(1)}% indicates reliable detection</li>
                        <li>High tonal clarity suggests good harmonic analysis</li>
                        <li>Fast processing time (${avgProcessingTime.toFixed(0)}ms average) shows efficiency</li>
                    </ul>
                    <p><strong>Recommendation:</strong> Algorithm is ready for production use.</p>
                `;
                assessmentClass = 'excellent';
            } else if (successfulAnalyses >= totalFiles * 0.8 && avgConfidence >= 0.5) {
                assessment = `
                    <h3 style="color: #ff9800;">‚ö†Ô∏è ALGORITHM WORKING WITH MINOR ISSUES</h3>
                    <p>The scale/key recognition algorithm is mostly functional but has some areas for improvement:</p>
                    <ul>
                        <li>${successfulAnalyses}/${totalFiles} files analyzed successfully</li>
                        <li>Average confidence of ${(avgConfidence * 100).toFixed(1)}% is acceptable but could be improved</li>
                        <li>${lowConfidenceCount} files had low confidence detection</li>
                    </ul>
                    <p><strong>Recommendation:</strong> Consider tuning the algorithm parameters or improving preprocessing.</p>
                `;
                assessmentClass = 'warning';
            } else {
                assessment = `
                    <h3 style="color: #f44336;">‚ùå ALGORITHM NEEDS SIGNIFICANT IMPROVEMENT</h3>
                    <p>The scale/key recognition algorithm has significant issues:</p>
                    <ul>
                        <li>Only ${successfulAnalyses}/${totalFiles} files analyzed successfully</li>
                        <li>Low average confidence of ${(avgConfidence * 100).toFixed(1)}%</li>
                        <li>${lowConfidenceCount} files had very low confidence detection</li>
                    </ul>
                    <p><strong>Recommendation:</strong> Algorithm needs debugging and significant improvements before production use.</p>
                `;
                assessmentClass = 'error';
            }
            
            const overallAssessment = document.getElementById('overallAssessment');
            overallAssessment.className = assessmentClass;
            overallAssessment.innerHTML = assessment;
            
            document.getElementById('summary').style.display = 'block';
        }

        async function runFullBatchTest() {
            await runBatchTest(TEST_FILES);
        }

        async function runQuickTest() {
            await runBatchTest(['Test_1.wav', 'Test_5.wav', 'Test_10.wav']);
        }

        async function runBatchTest(files) {
            const btnBatch = document.getElementById('btnBatch');
            const btnQuick = document.getElementById('btnQuick');
            btnBatch.disabled = true;
            btnQuick.disabled = true;
            
            testResults = [];
            currentTestIndex = 0;
            totalTests = files.length;
            
            try {
                await initializeWasm();
                
                updateProgress(25, `Starting batch test of ${files.length} files...`);
                
                for (const filename of files) {
                    const result = await testAudioFile(filename);
                    if (result) {
                        console.log(`‚úÖ Successfully analyzed ${filename}:`, result);
                    } else {
                        console.log(`‚ùå Failed to analyze ${filename}`);
                    }
                    
                    // Brief pause between files
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                updateProgress(95, 'Generating summary...');
                generateSummary();
                updateProgress(100, 'Batch test complete!');
                
                console.log('üéº Batch test completed!');
                console.log('üìä Final Assessment:', testResults);
                
            } catch (error) {
                console.error('‚ùå Batch test failed:', error);
                addResult('Batch Test Error', `Batch test failed: ${error.message}`, 'error');
            } finally {
                btnBatch.disabled = false;
                btnQuick.disabled = false;
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testResults = [];
            currentTestIndex = 0;
            totalTests = 0;
        }

        // Make functions globally available
        window.runFullBatchTest = runFullBatchTest;
        window.runQuickTest = runQuickTest;
        window.clearResults = clearResults;
        
        // Initialize on page load
        console.log('üéº Filesfortest Batch Key Detection Tool Ready');
        console.log('üìÅ Will test files:', TEST_FILES);
        console.log('üöÄ Ready to test scale/key recognition algorithm!');
    </script>
</body>
</html> 