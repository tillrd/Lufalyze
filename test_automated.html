
<!DOCTYPE html>
<html>
<head>
    <title>Automated Key Detection Test</title>
</head>
<body>
    <div id="output"></div>
    <script type="module">
        import init, { MusicAnalyzer } from './dist/assets/loudness_wasm-BuItfBHM.js';
        
        const TEST_FILES = ["Test_1.wav","Test_2.wav","Test_3.wav","Test_4.wav","Test_5.wav","Test_6.wav","Test_7.wav","Test_8.wav","Test_9.wav","Test_10.wav"];
        const results = [];
        
        async function runTests() {
            try {
                await init();
                const musicAnalyzer = new MusicAnalyzer(44100);
                console.log('‚úÖ WASM initialized');
                
                for (const filename of TEST_FILES) {
                    try {
                        console.log(`üìÇ Testing ${filename}...`);
                        
                        const response = await fetch(`filesfortest/${filename}`);
                        if (!response.ok) {
                            throw new Error(`Failed to load ${filename}`);
                        }
                        
                        const arrayBuffer = await response.arrayBuffer();
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        const pcmData = audioBuffer.getChannelData(0);
                        const float32Array = new Float32Array(pcmData);
                        
                        const startTime = performance.now();
                        const result = musicAnalyzer.analyze_music(float32Array);
                        const endTime = performance.now();
                        
                        results.push({
                            filename,
                            success: true,
                            data: {
                                key: result.key,
                                root_note: result.root_note,
                                is_major: result.is_major,
                                confidence: result.confidence,
                                tonal_clarity: result.tonal_clarity,
                                harmonic_complexity: result.harmonic_complexity,
                                processingTime: endTime - startTime,
                                scales: Array.from(result.scales)
                            }
                        });
                        
                        console.log(`‚úÖ ${filename}: ${result.key} (${(result.confidence * 100).toFixed(1)}%)`);
                        
                    } catch (error) {
                        console.error(`‚ùå Error testing ${filename}:`, error);
                        results.push({
                            filename,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                // Output results for Node.js to read
                document.getElementById('output').textContent = JSON.stringify(results, null, 2);
                console.log('üéº All tests completed');
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                document.getElementById('output').textContent = JSON.stringify({ error: error.message });
            }
        }
        
        runTests();
    </script>
</body>
</html>